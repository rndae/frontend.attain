<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Report</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
    <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/solid.js" integrity="sha384-tzzSw1/Vo+0N5UhStP3bvwWPq+uvzCMfrN1fEFe+xBmv1C/AtVX5K0uZtmcHitFZ" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
     <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
     <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
     <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <!-- Popper.JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
    <!-- Bootstrap JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>
    <script src="scripts/2pdf/html2pdf.bundle.min.js"></script>
    <script src="scripts/2pdf/utils.js"></script>
     <link rel="stylesheet" type="text/css" href="/css/reportstyle.css">
        <script>
      function generatePDF() {
        // Choose the element that our invoice is rendered in.
        const element = document.getElementById("report");
        // Choose the element and save the PDF for our user.

        var opt = {
        margin:       -1,
        filename:     'report.pdf',
        image:        { type: 'jpeg', quality: 1 },
        html2canvas:  { dpi: 300, letterRendering: true ,width: 1040},
        jsPDF:        { unit: 'mm', format: 'letter', orientation: 'portrait' }
      };
        html2pdf()
          .from(element)
          .set(opt)
          .save();
      }
    </script>


  </head>

  <body>

    <ul class="nav nav-tabs justify-content-center">
      <li class="nav-item">
        <a class="nav-link active" data-toggle="tab" href="#home">System Report</a></li>
    </ul>
    <div class="row justify-content-center mb-0">
      <div class="tab-content">
        <div id="home" class="tab-pane fade show active " >
        <h3 class="reTitle">System Report</h3>
        <form class="form" >
            <label for="startDay">Start Day:</label>
            <input type="date" id="startDay" name="startDay" >
            <label for="endDay">End Day:</label>
            <input type="date" id="endDay" name="endDay" min="startDay">
             <button type='button' onclick="datechecker()">Submit</button>
        </form>


      <section class="product-section bg-img">
       <button class="mb-4 mt-5" onclick="generatePDF()">Download as PDF</button>
       <hr>
       <div  id="report">
       <div class="container">
        <div class="row justify-content-center pb-4 pt-0">
          <div class="col-md-7 heading-section text-center">

             <p class=" glowp mt-0 mb-1" id="myPeriod"></p>
             <p class=" glowp mb-1"id="Time"></p>
             <p class=" glowp "id="Roadway"></p>
          </div>
        </div>
        <div class="board"></div>
         <div class="row justify-content-center pb-4 pt-4">
          <div class="heading-section text-center">
             <h2 class="font-weight-bold text-color2 glow mt-3 mb-0 text-uppercase" id="topTitle"></h2>
          </div>
        </div>

        <div id="aa"><div>
          <div class="row justify-content-center">
            <div class="heading-section text-center">
            <canvas class="mychart mb-2" id="myChart"></canvas>
            </div>
          </div>

        <script>
          function datechecker() {
            const startDate = document.getElementById("startDay").value;
            const endDate = document.getElementById("endDay").value;
            const baseURL = 'http://10.32.93.91:8085/highCrashFreq/getDataOrderByDur/';
            const roadTypes = ['Merge', 'Diverge', 'Weaving', 'ExpressRelated','Ramp'];

            document.getElementById("myPeriod").innerHTML = `Period: ${startDate} - ${endDate}`;
            document.getElementById("Time").innerHTML = "Time: Full Day";
            document.getElementById("Roadway").innerHTML = "Roadway Facility Type: All";
            document.getElementById("topTitle").innerHTML = "Top Crash Prone Location by Facility Type";

            let summaryData = [];
            let detailedData = {};

            function processAllData() {
                let html = '<table class="top5 mb-5"><tr><th>Road ID</th><th>Road Type</th><th>Reported Cases</th></tr>';
                
                // Add summary rows
                summaryData.forEach(item => {
                    html += `<tr><td>${item.roadName}</td><td>${item.roadwayType}</td><td>${item.total}</td></tr>`;
                });
                html += '</table>';

                // Create detailed sections for each road type
                roadTypes.forEach((type, i) => {
                    html += createDetailedSection(type, `myChart${i + 1}`, detailedData[type]);
                });

                // Insert HTML and create charts
                $('#aa').html(html);
                roadTypes.forEach((type, i) => {
                    createChart(`myChart${i + 1}`, detailedData[type].map(loc => loc.roadName), detailedData[type].map(loc => loc.total));
                });
            }

            function processData(data, roadType) {
                // Store summary data
                summaryData.push({
                    roadName: data[0].roadName,
                    roadwayType: data[0].roadwayType,
                    total: data[0].total
                });

                // Store top 5 locations
                detailedData[roadType] = data.slice(0, 5);

                // If we've processed all road types, generate the final output
                if (summaryData.length === roadTypes.length) {
                    processAllData();
                }
            }

            function createDetailedSection(roadType, chartId, locations) {
                return `
                    <div class="board"></div>
                    <div class="heading-section text-center">
                        <h2 class="font-weight-bold text-center text-color2 glow mt-5">${roadType.toUpperCase()} SEGMENTS: TOP 5 LOCATIONS </h2>
                    </div>
                    <div class="row justify-content-center">
                        <div class="heading-section text-center">
                            <canvas class="mychart mb-2" id="${chartId}"></canvas>
                        </div>
                    </div>
                    <table class="details mb-5">
                        <tr>
                            <th class="bg-color3 text-center "></th>
                            <th class="bg-color text-center" colspan="2">Peak</th>
                            <th class="bg-color2 text-center" colspan="2">Non-Peak</th>
                        </tr>
                        <tr>
                            <th>Road ID</th>
                            <th>AM</th>
                            <th>PM</th>
                            <th>Daytime</th>
                            <th>Nighttime</th>
                        </tr>
                        ${locations.map(loc => `
                            <tr>
                                <td>${loc.roadName}</td>
                                <td>${loc.amPeak}</td>
                                <td>${loc.pmPeak}</td>
                                <td>${loc.dayTimeNonPeak}</td>
                                <td>${loc.nightTimeNonPeak}</td>
                            </tr>
                        `).join('')}
                    </table>
                `;
            }

            function createChart(chartId, labels, data) {
                const ctx = document.getElementById(chartId).getContext('2d');
                return new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Frequency',
                            yAxisID: 'Frequency',
                            data: data,
                            backgroundColor: Array(data.length).fill('#ffc85c')
                        }]
                    },
                    options: {
                        scales: {
                            yAxes: [{
                                id: 'Frequency',
                                type: 'linear',
                                position: 'left',
                                ticks: { beginAtZero: true }
                            }]
                        }
                    }
                });
            }

            function getJSON(url, callback) {
                const xhr = new XMLHttpRequest();
                xhr.open('GET', url, true);
                xhr.responseType = 'json';
                xhr.onload = () => {
                    if (xhr.status === 200) {
                        callback(null, xhr.response);
                    } else {
                        callback(xhr.status);
                    }
                };
                xhr.send();
            }

            roadTypes.forEach((roadType) => {
                const url = `${baseURL}${startDate}/${endDate}/${roadType}`;
                getJSON(url, (err, data) => {
                    if (err) {
                        console.error(err);
                    } else {
                        processData(data, roadType);
                    }
                });
            });
        }
                  
              


        </script>   <!--    end of chart.js -->
 <!---->

       </div> <!-- container   -->
      </div>  <!-- crash report -->
    </section>

</div> <!-- id = home -->

      <div id="menu1" class="tab-pane fade">
        <h3 class="reTitle">PATM Report</h3>
        <form class="form">
            <label for="startDay">Start Day:</label>
            <input type="date" id="startDay" name="startDay">
            <label class="endday"for="endDay">End Day:</label>
            <input type="date" id="endDay" name="endDay">
             <button type='button' onclick="datechecker()">Submit</button>
        </form>
          <section class="product-section bg-img">
             <button class="mb-4 mt-5" onclick="generatePDF()">Download as PDF</button>
             <hr>
             <div  id="report">
             <div class="container">
              <div class="row justify-content-center pb-4 pt-0">
                <div class="col-md-7 heading-section text-center">
                 <p class=" glowp mt-0 mb-1" >Period: 11/16/2020</p>
                 <p class=" glowp mb-1">Time: Full Day</p>
                 <p class=" glowp ">Roadway Facility Type: All</p>
                </div>
              </div>
              <div class="board"></div>
               <div class="row justify-content-center pb-4 pt-4">
                <div class="col-md-7 heading-section text-center">
                   <h2 class="font-weight-bold text-color2 glow mt-3">PATM Recommendation</h2>
                </div>
              </div>

        <table class="details">
                  <p class="table-name">(Recommended Countermeasures During Time of the Day) </p>
          <tr>
            <th class = "bg-color3 text-center "></th>
            <th class = "bg-color3 text-center "></th>
            <th class = "bg-color text-center "colspan="2">Peak</th>
            <th class = "bg-color2 text-center" colspan="2">Non-Peak</th>
          </tr>

          <tr>
            <th>Road ID</th>
            <th>Road Type</th>
            <th>AM</th>
            <th>PM</th>
            <th>Daytime</th>
            <th>Nighttime</th>
          </tr>
          <tr>
            <td>I-4 @ MM 084.3--WB</td>
            <td>Alfreds Futterkiste</td>
            <td>Maria Anders</td>
            <td>Alfreds Futterkiste</td>
            <td>Maria Anders</td>
            <td>Maria Anders</td>
          </tr>
          <tr>
            <td>I-4 @ MM 084.3--WB</td>
            <td>Alfreds Futterkiste</td>
            <td>Maria Anders</td>
            <td>Alfreds Futterkiste</td>
            <td>Maria Anders</td>
            <td>Maria Anders</td>
          </tr>
          <tr>
            <td>I-4 @ MM 084.3--WB</td>
            <td>Alfreds Futterkiste</td>
            <td>Maria Anders</td>
            <td>Alfreds Futterkiste</td>
            <td>Maria Anders</td>
            <td>Maria Anders</td>
          </tr>
          <tr>
            <td>I-4 @ MM 084.3--WB</td>
            <td>Alfreds Futterkiste</td>
            <td>Maria Anders</td>
            <td>Alfreds Futterkiste</td>
            <td>Maria Anders</td>
            <td>Maria Anders</td>
          </tr>
          <tr>
            <td>I-4 @ MM 084.3--WB</td>
            <td>Alfreds Futterkiste</td>
            <td>Maria Anders</td>
            <td>Alfreds Futterkiste</td>
            <td>Maria Anders</td>
            <td>Maria Anders</td>
          </tr>
          <tr>
            <td>I-4 @ MM 084.3--WB</td>
            <td>Alfreds Futterkiste</td>
            <td>Maria Anders</td>
            <td>Alfreds Futterkiste</td>
            <td>Maria Anders</td>
            <td>Maria Anders</td>
          </tr>
        </table>
             </div>
             </div>
         </section>
      </div> <!-- id = menu1 -->

      </div>
    </div>

  </body>
</html>